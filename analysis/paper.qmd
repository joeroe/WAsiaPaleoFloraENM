---
title: Biogeography of crop progenitors and wild plant resources in the terminal Pleistocene and Early Holocene of West Asia, 14.7–8.3 ka
date: today
author: 
- name: Joe Roe
  id: jr
  orcid: 0000-0002-1011-1244
  email: joeroe@hey.com
  url: https://joeroe.io
  affiliations:
    - name: University of Bern
      country: Switzerland
    - name: University of Copenhagen
      country: Denmark
  corresponding: true
- name: Amaia Arranz-Otaegui
  id: aao
  orcid: 0000-0002-5091-6426
  affiliation: 
    - name: University of the Basque Country
      country: Spain
abstract: |
  This paper presents the first continuous, spatially-explicit reconstructions 
  of the palaeodistributions of 82<!-- TODO update --> plant species found regularly in association 
  with early agricultural archaeological sites in West Asia, including the 
  progenitors of the first crops. We used machine learning to train an 
  ecological niche model of each species based on its present-day distribution 
  in relation to climate and environmental variables. Predictions of the 
  potential ranges of these species at key stages of the Pleistocene–Holocene 
  transition could then be derived from these models using downsampled data from 
  palaeoclimate simulations.
  The models predict significant reductions and/or shifts in species ranges in
  the terminal Pleistocene and Early Holocene compared to present conditions. 
  Many species that are found throughout the region's 'hilly flanks' today 
  are indicated to have much more restricted distributions centered on the 
  Levant, Cyprus and Western Anatolia. In addition, overall ranges shrunk by an 
  average of c. 25% from the terminal Pleistocene to the Early Holocene. 
  Modelled ranges do not reliably predict the observed  occurrence of specific 
  species at archaeological sites, but are aligned with more general trends in
  the relative abundance of species.<!--
  however [...]
  The regional ubiquity of species in the archaeological record is [not] correlated with the 
  predicted size of its range and the diversity of archaeobotanical assemblages is [not] 
  correlated with the predicted diversity of its environs. This indicates that 
  trends in taxonomic composition of the archaeobotanical record is [not] likely 
  to have been influenced by environmental change and species turnover, in
  addition to human economic choices.-->
format: 
  elsevier-pdf:
    keep-tex: true
    # cite-method: citeproc
    journal:
      name: Open Quaternary
      formatting: preprint
      cite-style: authoryear
bibliography: references.bib
execute: 
  echo: false
---

<!--

* [x] Stop modelling
- [x] First draft:
- [x] Figures
- [ ] Biogeography background section
- [ ] Revise discussion of archaeo verification
- [ ] Outstanding TODOs
- [ ] Add missing references
- [ ] Copyedit
- [x] Appendix with all hindcast predictions (HTML?)
- [ ] Clean up package code
- [ ] Zenodo release
- [ ] Final proofread

-->

```{r dependencies, message=FALSE}
library("cowplot")
library("dplyr")
library("dotenv")
library("english")
library("forcats")
library("fs")
library("furrr")
library("ggplot2")
library("ggrepel")
library("ggspatial")
library("gt")
library("here")
library("khroma")
library("progressr")
library("purrr")
library("ranger")
library("readr")
library("recipes")
library("rgbif")
library("scales")
library("sf")
library("stars")
library("stringr")
library("tibble")
library("tidymodels")
library("tidyr")

library("BadiaPaleoFloraENM") # this package, install with devtools::install()
```

```{r setup-parallel}
# Several parts of this analysis are processing- and memory-intensive.
# You may need to adjust the futures strategy specified here to fit your 
# computational resources. See ?future::plan for options.
plan("multisession")
```

```{r define-regions}
latlong <- 4326
w_asia_albers <- "+proj=aea +lat_1=22.5 +lat_2=42.5 +lon_0=40"

w_asia <- st_bbox(c(xmin = 25, xmax = 55, ymin = 22.5, ymax = 42.5), crs = 4326)

levant <- st_bbox(c(xmin = 33, xmax = 39, ymin = 30, ymax = 38))
s_levant <- st_bbox(c(xmin = 34, xmax = 39, ymin = 29, ymax = 34), crs = 4326)
```

```{r define-periods}
archaeo_periods <- tribble(
  ~period,             ~agriculture,                          ~start_bp, ~end_bp,
  "Late Epipal.",      "Foraging",                            15000,     11700,
  "PPNA",              "Pre-domestication cultivation",       11700,     10700,
  "EPPNB",             "Cultivation of domesticated species", 10700,     10200,
  "MPPNB",             "Cultivation of domesticated species", 10200,     9500,
  "LPPNB/C",           "Agriculture",                         9500,      8500,
  "Pottery Neolithic", "Agriculture",                         8500,      6500,
  "Chalcolithic",      "Agriculture",                         6500,      5000,
)

epipal <- c("Late Epipal.")
ppn <- c("PPNA", "EPPNB", "MPPNB", "LPPNB/C")

climate_periods <- tibble(
  period = c("Bølling-Allerød", "Younger Dryas", "Early Holocene", "Current"),
  code = c("ba", "yds", "eh", "cur"),
  date_range = c("(14.7-12.9 ka)", "(12.9-11.7 ka)", "(11.7-8.3 ka)", ""),
  label = fct_inorder(paste(toupper(code), date_range)),
  long_label = fct_inorder(paste(period, date_range)),
  start_bp = c(14700, 12900, 11700, NA),
  end_bp = c(12900, 11700, 8300, NA)
)
```

```{r define-parameters}
# Minimum number archaeological occurrences for modelling
min_n_archaeo <- 1

# Minimum number of present occurrences for modelling
min_n_occ <- 50

# Number of background samples per taxon
n_background <- 10000

# Raster resolution for prediction (meters)
pred_res <- 5000
```

# Introduction

The Pleistocene–Holocene transition in West Asia marked a turning point in global environmental history, as humans brought the first plants under cultivation and began modifying surrounding ecosystems to support their own subsistence.
West Asia is part of the native range of a remarkable number of domesticable plant species, including wild relatives of wheat, barley, peas, lentils, and other crops of global importance [@Diamond2002].
These species supported uniquely dense and complex Late Epipalaeolithic (15–11.7 ka) societies based on intensive foraging [@BarYosef1998; @MaherEtAl2012] and eventually plant management and pre-domestication cultivation [@Harris2007].
As they were brought under domestication in the Pre-Pottery Neolithic period (11.7–8.5 ka), the world's first agriculture was shaped by the ecosystems from which it emerged and was embedded in.

Decades of research in archaeobotany and zooarchaeology have reconstructed the subsistence economies of Late Epipalaeolithic and Neolithic sites in great detail.
Together with studies of charcoal, pollen, soil, and a variety of palaeoclimate archives [@JonesEtAl2019], they also tell us much about the environments surrounding these settlements.
However, each of these sources of evidence is subject to the wide variety of taphonomic and recovery biases that are inherent in any direct record of the past.
They are also, by definition, records of the (human) environment at particular times and places.
Interpolating these snapshots to give a holistic picture of the regional ecologies is not straightforward – to date, it has tended to rely on non-explicit, inductive modelling.
The majority are also filtered through human action, producing a mixed single that makes it difficult to disentangle anthropic effects from the background of environmental change in this period of rapid climatic alteration.

In this paper we present a complementary, deductive approach based on ecological niche modelling.
Rather than inferring environmental conditions from preserved physical evidence, 
we predict the ranges of individual species relevant to human subsistence based on a model of their current environmental niche and simulations of past palaeoclimate. 
Though hypothetical, this gives us an independent line of evidence on past ecologies that is independent of the environmental archaeological and palaeoclimatic records.
This means that the ancient data can be reserved for assessing the model's ability to 'hindcast' past conditions.
In this sense, discrepencies between the two records are perhaps the most interesting result, as they indicate processes affecting one or both records that are not fully accounted for and therefore generate new questions.
Our computational approach is also readily scaled up, allowing us to model spatially-explicit palaeodistributions for a large number of species, for the whole region, under multiple past climatologies.

# Background {#sec-bg}

The transition to agriculture represents one of the most fundamental changes in human history.
West Asia is one of the regions where this process has been studied in the most detail:
decades of research have traced the gradual development of a Neolithic way of life and the changes that occurred in the plant species and their geographical distribution as a result.
Although archaeobotanical assemblages can be biased due to issues of preservation, sampling, recovery techniques, and lab procedures [Dennel 1976, Hastorf and Popper 1988] —and although they include not just food remains but plant resources that were used for other purposes or arrived at the site accidentally [@HastorfPopper1988]—large-scale studies have still revealed coherent patterns in the exploitation of plants over time [Colledge et al. 2004, Arranz-Otaegui et al. 2016].

The possibility of an abrupt, geographically-constrained process of plant domestication was proposed in the 1990s [@HillmanDavies1990; @HillmanDavies1992; @HeunEtAl1997; @OzkanEtAl2002] and developed as an explanatory model in the 2000s [@LevYadunEtAl2000; @GopherEtAl2001; @AbboEtAl2005].
As part of this model, some authors [Lev-Yadun, Gopher and Abbo 2000, Gopher, Abbo and Lev-Yadun 2001, Abbo, Lev-Yadun and Gopher 2010, 2012] argued that eight plant species, collectively referred to as 'founder crops' or the 'Neolithic crop package' [Zohary and Hopf 1988] were selected and domesticated once, without any phase of pre-domestication cultivation [Abbo, Lev-Yadun and Gopher 2011, p. 177)].
This process could have been rapid under strong artificial selection [Hillman and Davies 1990, 1992] and may have occurred in a single region or 'core area' – generally located in southeast Turkey [Ladizinsky and Adler 1976, Heun et al. 1997, Özkan et al. 2002, 2005, Mori et al. 2003, Luo et al. 2007]. 
From this single point of origin, it was supposed that domesticated or semi-domesticated plants radiated outwards to other regions [Abbo et al. 2006, Kilian et al. 2007, Özkan et al. 2011].

The 'short gestation' paradigm was challenged by others [Helbaek 1969, Harris 1989, Kislev 1989, Colledge 2001, Weiss et al. 2004, Willcox et al. 2008, Fuller et al. 2018]. 
@Helbaek1966 argued that before the appearance of domesticated plants, a phase of cultivation of wild seeds must have taken place. 
The existence of a phase of cultivation of morphologically wild cereals or 'pre-domestication cultivation' was identified in the archaeological record through the study of plant domestication traits such as grain size, shattering v. non-shattering rachises. 
The archaeobotanical evidence shows that during the Pre-Pottery Neolithic A (PPNA) cereals exhibited sizes similar to those recorded in domestic species, but their dispersal mechanism was still the same as the one present in morphologically-wild species [i.e. shattering, see Helbaek 1966, Kislev 1989, Hillman et al. 2000, Colledge 2001, Willcox et al. 2008].
This evidence suggested that wild cereal stands could have been cultivated for as much as a thousand years before non-shattering domestic forms became prevalent in the archaeological record [Tanno and Willcox 2006, 2012, Arranz-Otaegui et al. 2016)].
Additional archaeobotanical [Colledge 2001, Willcox et al. 2008, 2009, Riehl et al. 2013, Arranz-Otaegui et al. 2016, Weide et al. 2018, Douché and Willcox 2018, Whitlam et al. 2018] and genetic data [Badr et al. 2000, Molina-Cano et al. 2005, Kilian et al. 2007, Özkan et al. 2011, Lob et al. 2023 VHA] in recent years has further challenged the short-gestation model to explain the origins of plant domestication and agriculture in West Asia. 

Similarly, the concept of a limited set of eight 'founder crops' [@ZoharyHopf1988] that were the first species cultivated, domesticated and then spread as the basis of Neolithic agricultural systems, is not supported by the latest evidence.
Our previous analyses of the composition of available archaeobotanical datasets shows that these crops were of marginal importance during the Epipalaeolithic period [@ArranzOtaeguiEtAl2018] and that Neolithic subsistence did not rely either solely or primarily on the exploitation of these species [Arranz-OtaeguiRoe2023]. 
Instead, multiple species of grasses, legumes, fruits, nuts, and other plants were exploited over the Late Pleistocene-Early Holocene transition in southwest Asia. 

## Biogeography and agricultural origins

The study of the natural distribution of the progenitors of domesticated crops has been a central part of discussions on the origins of agriculture and plant domestication from the beginning.
@Humboldt1807 acknowledged the importance of the natural distribution of wild species to explain the origin and domestication of crops like spelt and rye.
@Candolle1820 integrated the study of plant ecology and biogeography and influenced @Darwin1859, who later reflected in detail about the geographical distribution of plants and species diversity. 
At that time, there was intense debate about whether there were single or multiple "centres of creation" of species. 
Researchers aimed to evaluate whether plant and animal species emerged in the same locations where they were currently distributed. 

After Darwin, this early interest in crop origins evolved into more specific discussions about the "centres of plant domestication".
Vavilov [@Vavilov1926; @Vavilov1950] can be considered one of the first authors that sought to determine the number of regions in which plants had been independently domesticated. 
His main method was 'differential phytogeography' [@Vavilov1950]: 
he classified the variation within a crop and established the regions of maximum diversity, to locate the geographic regions in which crops originated. 
Using this method, Vavilov suggested that there were at least eight centres of origin. 
However, his work was later criticised by @Harlan1971, who argued that 'centres of origin' and 'centres of diversity' had to be separated. 
For Harlan, a 'centre' was as an "area in which things originate and out of which things are dispersed" [@Harlan1971, p. 468], and he suggested that three main centres of origin of domesticated crops existed.
He further indicated that Vavilov's approach to the question was simplistic and that more data proxies had to be considered (e.g. archaeology, history, geology…), an approach more in the tradition of @Candolle1909. 
Indeed, the inclusion of archaeobotany and genetics in the last decades, together with the study of wild relative distributions has been fundamental in characterising the origins of agriculture [@FullerColledge2008]. 
As a result of modern interdisciplinary studies, the number of recognised centres of plant domestication has increased considerably, from the three centres suggested by Harlan in 1971 to the six to eight centres argued for in the 1990s [@Smith1995] and up to as much as 24 potential centres reported in 2009 [@PuruggananFuller2009; see also @Fuller2010].

Biogeographic research into the centres of origin and/or domestication of crops has directly informed broader understanding of the process of agricultural origins.
In particular, Childe's *Man Makes Himself* [-@Childe1936] both set the agenda for much of the archaeological work that took place between the end of the Second World War and the 80s [e.g. @BraidwoodBraidwood1950; @Kenyon1952; @Kenyon1960; @Braidwood1981; @HoleFlannery1968; @Moore1975] and stimulated theoretical discussions on the subject [e.g. @Sauer1952; @Harris1969; @Harris1977; @Harris1989; @Flannery1973; @Hawkes1969]. 
Childe (unlike for example @Pumpelly before him) correctly located the centre of origin of European agriculture in West Asia, but not based on the region's prehistoric archaeological record, which at that point was barely known.
Instead he was guided to the region by biogeographic work by Vavilov and @PeakeFleure1927;
only later was this prediction validated by archaeological work on the Epipalaeolithic and Neolithic of Palestine [@Boyd2018].

Contemporary research on crop origins was pioneered by Harlan and Zohary, who compared the current distribution of the wild progenitors of domesticated plants in southwest Asia [@HarlanZohary1966; @Zohary1969; @Zohary1973; @ZoharyHopf1973] to the rapidly-expanding archaeobotanical record [@Harlan1971; @Harlan1977; see also @ZoharyHopf1988; @HarlanZohary1966].
They both were interested in evaluating which were the wild ancestors of domesticated crops and studying their natural distribution to understand their domestication process [Zohary 1969, Zohary 1973, 1992, Zohary and Spiegel-Roy 1975]. 
Indeed, the natural distribution of the wild relatives of domestic plant species was later used as a criterion to infer 'pre-domestic cultivation' in the archaeological record. 
For example, the presence of seeds of chickpea at Jericho [Hopf 1983, see also Hopf 1969] led the author to interpret the remains as cultivars, as the natural distribution of the wild form of chickpea was located further to the north. 
The same rationale was applied to the einkorn remains found at several Pre-Pottery Neolithic sites in the southern Levant [Hopf 1969, Colledge 2001], as the wild progenitors of this species was thought to be restricted to the northern Levantine area [Heun et al. 1997, 2009, Zohary and Hopf 2000]. 
The same idea—presence of plants outside their natural range—has been repeated in the literature more recently by several other authors [Tanno and Willcox 2006, Willcox et al. 2008, Hilman et al. 2000]. 

Despite the importance of biogeography in the development and validation of hypotheses regarding the origins of agriculture, there have been few studies of the wild range of specific crop progenitors or other relevant plant species [cf. for domestic animals, e.g. @YeomansEtAl2017].
Observations regarding translocation or range expansion must therefore rely on a relatively rough and ahistoric notion of a species' 'natural distribution' – that is, one based primarily on contemporary or recent-historic occurrences.
Yet we know there has been considerable climatic and environmental change in West Asia since the terminal Pleistocene [@JonesEtAl2019], so it is very unlikely that these ranges were in fact static.
Reconstructions of broader environments have attempted to trace their fluctuations through time, either for the entire region [e.g. @VanZeistBottema1991; Hillman2000] or parts of it [e.g. @Cordova2007], but these are at the level of the vegetation zone rather than individual species.
They also invariably rely on what might be called 'expert interpolation' (where the author composes a map based on his or her own knowledge of the relevant data) rather than an explicit modelling process.
This makes it difficult, if not impossible, for users of such reconstructions to understand exactly how they were derived or what could explain, for example, the significant discrepencies between the predictions of different experts.

<!-- TODO: figure highlighting discrepencies between 'expert interpolation' -->

## Ecological niche modelling in archaeology

Ecological niche modelling or species distribution modelling is widely used by ecologists to predict the geographic range of a species based on a set of environmental predictors [@FranklinMiller2009].
Essentially, it involves combining records of where an organism has been observed with environmental data (climate, topography, etc.) for those locations to model the range of environmental values at which that species  – its environmental niche.
This model can then be used to predict the range of the organism in question either in the same or a different environment.
@TownsendPetersonSoberon2012 suggests reserving the term 'species distribution modelling' for when the method is used to recover the verifiable range of a species in a real and existing environment, and using 'ecological niche modelling' as the broader term covering hypothetical or predictive applications – a convention we follow here when referring to predictive or 'hindcast' models of past ranges.
Within this overarching framework, ecological niche modelling encompasses a wide range of applications and a variety of potential environmental predictors, modelling approaches, and methodologies, which we will not attempt to review here.

Ecological niche modelling has long been of interest to archaeologists as both a means of exploring the biological niche of humans and for reconstructing the past environments they inhabited [@DavidPollyEronen2011; @FranklinEtAl2015].
In the first sense, it has been used most extensively to model the range of humans and other hominin species [e.g. @BenitoEtAl2017; @YousefiEtAl2020; @BanksEtAl2021; @YaworskyEtAl2024a; @YaworskyEtAl2024b; @GuranEtAl2024], especially in the Palaeolithic.
This overlaps with what archaeologists usually call generically 'predictive modelling' [@VerhagenWhitley2020]—or more precisely 'site distribution modelling'—which is essentially the same approach as (and often borrows methodologies from) ecological niche modelling but applied to the occurrence of archaeological sites.
Here what is modelled is not strictly a biological niche alone, but also aspects of human geography, taphonomy, and archaeological visibility.
These applications can be distinguihed from 'palaeoecological niche modelling', where the object of model remains, as in ecology, a non-human biological niche.

@FranklinEtAl2015 review palaeoecological niche modelling and advocate for its greater adoption in environmental archaeology.
In an early application to West Asia, @ConollyEtAl2012 used the occurrence of wild and domestic *Bos* remains at prehistoric archaeological sites to map the evolving niche of cattle over the Pleistocene–Holocene transition.
It has been used to model the availability of fauna exploited by humans at wider scales [e.g. @deAndresHerreroEtAl2018; @YaworskyEtAl2023] and, in a West Asian context, of foraged plant resources in the landscape around the Neolithic sites on the Konya Plain [@CollinsEtAl2018].
Modelling the spread of crops has been another significant archaeological application [e.g. @KrzyzanskaEtAl2022; @Krzyzanska2023], though not as yet applied to West Asia.

In the majority of studies to date (palaeo)ecological niche modelling has been applied to archaeological data in an 'inductive' fashion, i.e. faunal and botanical remains from ancient sites are used as the occurrence dataset for training a model using either past or present environmental data.
However, both the zooarchaeological and archaeobotanical records are sparse and subject to a complex array of depositional, taphonomic and recovery biases factors that , many of which are not fully understood and/or cannot be corrected for.
This means that while the archaeological attestation of the presence of a species might generally be relied upon, it is highly unlikely that its absence is representative of true past distributions.

The alternative approach is to train the model using contemporary occurrence and environmental data and then use palaeoenvironmental data to 'hindcast' its predictions backwards in time.
Like @FranklinEtAl2015, we view the hindcasting approach as more promising, because training datasets for both occurrences and environment are far more readily available, complete and reliable for the present than the past.
There is some scepticism in the ecological niche modelling literature about the ability of such models to make accurate predictions in unknown environments [like the past, @FranklinEtAl2015], 
but here the hindcasting approach also presents an opportunity:
it reserves archaeological occurrence data as an independent dataset that can be used to assess the retrodictive performance of the model.
This possibily was suggested by @FranklinEtAl2015 but to our knowledge our study represents the first attempt to actually do so.

The major practical limitation of the hindcasting approach is that it relies on spatially explicit, high resolution palaeoenvironmental surfaces with continuous coverage of the region and periods of interest.
Until recently, this has not been widely available for most applications, which is perhaps why only a minority of studies use it [cf. @KrzyzanskaEtAl2022; @YaworskyEtAl2023].
In this study, we are able to take advantage of the increasing availability of high resolution, global palaeoclimate data derived from simulation experiments with general circulation models of climate [@BrownEtAl2018; @BrownEtAl2020; @KargerEtAl2023].

# Data and model

```{r data-basemap, message=FALSE}
# Turn off s2 while we deal with Natural Earth's dodgy geometries
use_s2 <- sf_use_s2(FALSE)

ne_countries <- read_sf(raw_data("ne"), "ne_10m_admin_0_countries")

ne_rivers <- read_sf(raw_data("ne"), "ne_10m_rivers_lake_centerlines_scale_rank")

ne_lakes <- read_sf(raw_data("ne"), "ne_10m_lakes") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_ocean <- read_sf(raw_data("ne"), "ne_10m_ocean") |>
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_union()

ne_land <- read_sf(raw_data("ne"), "ne_10m_land") |> 
  st_geometry() |>
  st_crop(buffer_bbox(w_asia, 10)) |>
  st_difference(ne_ocean) |>
  # st_difference(ne_lakes) |>
  st_union()

s_levant_land <- st_intersection(st_as_sfc(s_levant), ne_land)
w_asia_land <- st_intersection(st_as_sfc(w_asia), ne_land)

# Restore previous setting of s2
sf_use_s2(use_s2)
```

```{r data-flora}
# Start with flora present at archaeological sites
if (!file_exists(derived_data("flora.Rdata"))) {
  flora <- read_tsv(
    raw_data("swasia_neolithic_flora.tsv"),
    col_types = cols(
      source = col_character(),
      source_id = col_character(),
      source_site_name = col_character(),
      site_name = col_character(),
      latitude = col_double(),
      longitude = col_double(),
      phase = col_character(),
      phase_description = col_character(),
      phase_code = col_character(),
      age_start = col_integer(),
      age_end = col_integer(),
      taxon_source = col_character(),
      n = col_double(),
      prop = col_double(),
      reference = col_character(),
      taxon_detail = col_character(),
      taxon = col_character(),
      genus = col_character(),
      family = col_character(),
      category = col_character(),
      founder_crop = col_character(),
      edibility = col_character(),
      grass_type = col_character(),
      legume_type = col_character()
    )
  ) |>
    rename(taxon_group = "taxon", taxon = "taxon_detail") |>
    # Assign to archaeological periods
    mutate(
      age_mid = age_end + ((age_start - age_end) / 2),
      period = cut(
        -age_mid, 
        breaks = -c(archaeo_periods$start_bp, 0), 
        labels = archaeo_periods$period,
        ordered_result = TRUE
      ),
      climate_period = cut(
        -age_mid, 
        breaks = -c(climate_periods[climate_periods$code != "cur",]$start_bp, 0), 
        labels = climate_periods[climate_periods$code != "cur",]$code,
        ordered_result = TRUE
      )
    ) |>
    # Filter to Epipal/Neo
    filter(period %in% epipal | period %in% ppn) |>
    # Group by taxon
    drop_na(taxon) |>
    nest(.by = c(taxon), .key = "archaeo") |>
    # Normalise species names and match to the GBIF Backbone Taxonomy
    mutate(
      # Spot corrections
      taxon = case_match(
        taxon,
        "Vicia narbonense" ~ "Vicia narbonensis", # N=3
        "Triticum aestivocompactum" ~ "Triticum aestivum compactum", # N=3
        "Heliotropium persicum" ~ "Moltkia angustifolia", # N=2
        "Lens orientalis" ~ "Vicia orientalis", # N=2
        "Scirpus tabernaemontani" ~ "Schoenoplectus tabernaemontani", # N=2
        "Stipa capensis" ~ "Stipa dregeana", # N=2
        .default = taxon
      ),
      taxon_original = taxon,
      taxon = map_chr(taxon, gbif_accepted_name),
      .before = archaeo
    ) |>
    # Drop unmatched (mostly not identified to species)
    drop_na(taxon) |>
    # Recode domesticates as their wild progenitors.
    mutate(
      taxon = case_match(
        taxon,
        "Cicer arietinum" ~ "Cicer reticulatum",
        "Hordeum vulgare" ~ "Hordeum spontaneum",
        "Vicia lens" ~ "Vicia orientalis",
        "Linum usitatissimum" ~ "Linum bienne",
        "Triticum aestivum" ~ "Triticum turgidum dicoccum",
        "Triticum dicoccoides" ~ "Triticum turgidum dicoccum",
        "Triticum turgidum durum" ~ "Triticum turgidum dicoccum",
        "Triticum monococcum" ~ "Triticum monococcum aegilopoides",
        .default = taxon
      )
    ) |>
    # Regroup by canonical taxon
    summarise(
      taxon_aliases = list(taxon_original[taxon_original != taxon]),
      archaeo = list(bind_rows(archaeo)),
      .by = taxon
    ) |>
    mutate(
      n_archaeo = map_int(archaeo, nrow)
    ) |>
    filter(n_archaeo > min_n_archaeo) |>
    # Add wild progenitors of wheats
    bind_rows(
      tibble(
        taxon = c("Triticum urartu", "Aegilops speltoides", "Aegilops tauschii"),
        taxon_original = c("Triticum urartu", "Aegilops speltoides", "Aegilops tauschii")
      )
    )
  
  saveRDS(flora, derived_data("flora.Rdata"))
}
flora <- readRDS(derived_data("flora.Rdata"))
```

```{r data-archaeo-sites}
archaeo_sites <- flora |>
  unnest(archaeo) |>
  summarise(
    latitude = first(latitude), 
    longitude = first(longitude), 
    .by = c(site_name, period)
  ) |>
  st_as_sf(coords = c("longitude", "latitude"), crs = latlong)
```

```{r fig-region}
#| fig-cap: Late Epipalaeolithic & Pre-Pottery Neolithic archaeological sites used to generate modelled flora
ggplot() + 
  annotation_spatial(ne_land, fill = "#ffffff") +
  annotation_spatial(ne_rivers, aes(linewidth = strokeweig), colour = "lightblue") +
  layer_spatial(w_asia, fill = NA) +
  layer_spatial(archaeo_sites, size = 0.5) +
  scale_linewidth_identity() +
  coord_sf(crs = w_asia_albers)
```

The aim of our study was to model the biogeography of species relevant to human subsistence economies in West Asia (excluding the Southern Arabian peninsula, see @fig-region) during the archaeological Late Epipalaeolithic (15–11.7 ka) and Pre-Pottery Neolithic (11.7–8.3 ka) periods.
Based on current understandings, we assume that plant-based subsistence during this period was broad, geographically- and temporally-varied, and reflects a gradual, geographically decentred, and nonlinear tranistion to greater reliance on cultivars (i.e. agriculture, see @sec-bg).
Our starting point was a list of `r nrow(flora)` taxa (@tbl-results-summary) comprising the identifiable species observed at at least two Late Epipalaeolithic/Pre-Pottery Neolithic sites, according to our previous study of the regional archaeobotanical data [@ArranzOtaeguiRoe2023].
This was based on dataset collated from three previously published regional archaeobotanical databases: ADEMNES [@ADEMNES], ORIGINS [@ORIGINS], and COMPAG [@LucasFuller2018; @FullerEtAl2018; based on @ColledgeEtAl2004; @ShennanConolly2007].
We did not attempt to distinguish between the source of the remains [cf. @WallaceEtAl2018];
archaeobotanical assemblages are subject to a variety of preservational and recovery biases, so by no means were all the species on our list consumed or even deliberately collected by people.
However, we assume that there presence at a site of human settlement at least implies that they were part of the wider ecosystem that supported habitation there.

Taxonomic names were resolved to the canonical form specified in the GBIF Backbone Taxonomy [@GBIFSecretariat2023].
So for example occurrences for *Bolboschoenus maritimus* also include those recorded under the older nomenclature *Scirpus maritimus* (see @tbl-results-summary).
Domestic species meeting our inclusion criteria were substituted with their wild progenitor(s), where different.

## Occurrence data

<!-- TODO generate GBIF occurrence citation:
https://docs.ropensci.org/rgbif/articles/getting_occurrence_data.html -->

```{r data-n-occ} 
if (!file_exists(derived_data("flora_n_occ.Rdata"))) {
  message("Reacquiring GBIF occurrence counts...")
  flora <- flora |>
    mutate(
      n_occ = map_dbl(taxon, \(x) occ_count(scientificName = x, 
                                            hasCoordinate = TRUE, 
                                            hasGeospatialIssue = FALSE,
                                            geometry = bbox_wkt(w_asia)))
    )
  saveRDS(flora, derived_data("flora_n_occ.Rdata"))
}
flora <- readRDS(derived_data("flora_n_occ.Rdata"))
 
# Filter small samples
# ...and one very large one (why are there 50k occurrences of Avena sterilis?)
flora_all <- flora
flora <- flora |>
  filter(n_occ > min_n_occ) |>
  filter(taxon != "Avena sterilis")
```

```{r data-occ}
# Cleaning pipeline based on:
# - https://data-blog.gbif.org/post/gbif-filtering-guide/
if (!file_exists(derived_data("flora_occ.Rdata"))) {
  message("Reacquiring GBIF occurrences...")
  flora <- mutate(
    flora,
    occ = map(
      taxon, gbif_data, 
      hasCoordinate = TRUE, hasGeospatialIssue = FALSE, geometry = w_asia, 
      limit = 100000, .progress = TRUE
    ),
    occ = map(occ, filter, occurrenceStatus  == "PRESENT"),
    occ = map(occ, gbif_drop_imprecise_coords, threshold = 1000),
    occ = map(occ, gbif_drop_fossils),
    occ = map(occ, gbif_drop_duplicate_coords),
    occ = map(occ, gbif_standardise_names),
    occ = map(occ, \(x) {
      select(x, gbif_key = key, scientific_name, genus, species, longitude, 
             latitude)
    }),
    # Update occ count after cleaning
    n_occ = map_int(occ, nrow)
  )
  
  # Refilter based on cleaned records
  flora <- filter(flora, n_occ > min_n_occ)
  
  saveRDS(flora, derived_data("flora_occ.Rdata"))
}

flora <- readRDS(derived_data("flora_occ.Rdata"))
```

Georeferenced occurrence data for West Asia was obtained from the Global Biodiversity Information Facility (GBIF) using via its application programming interface and the R package 'rgbif' [@ChamberlainBoettiger2017; @rgbif].
GBIF was cleaned to removed fossil occurrences, recorded absences, and records with missing, imprecise (>1 km uncertainty), or invalid coordinates.
Although niche models have reasonable predictive power even with small training samples [@StockwellPeterson2002; @HernandezEtAl2006; @WiszEtAl2008], we excluded `r english(nrow(filter(flora_all, n_occ < min_n_occ)))` taxa with less than `r min_n_occ` usable occurrences, following recommendations for niche models generally and Random Forest-based models specifically [@StockwellPeterson2002; @LuanEtAl2020].
We also excluded one taxon (*Avena sterilis*) with over 50,000 occurrences, as this would have been computationally prohibitive and we were uncertain what accounted for such a disproportionately high number of records.

```{r fig-occ-map, fig.cap=paste0("Georeferenced occurrence records from West Asia used to train models (N=", nrow(unnest(flora, occ)))}
flora |>
 unnest(occ) |>
 distinct(latitude, longitude) |>
 st_as_sf(coords = c("longitude", "latitude"), crs = 4326) |>
 ggplot() +
 annotation_spatial(ne_land, fill = "#ffffff") +
 geom_sf(shape = ".") +
 layer_spatial(w_asia, fill = NA) +
 coord_sf(crs = w_asia_albers, default_crs = latlong)
```

```{r data-background}
# TODO: slow - cache
flora <- flora |>
  mutate(
    occ = map(occ, mutate, present = TRUE, weight = 1),
    bg = map(occ, function(x, region, n) { 
      background_sample(
        region = region, 
        N = n,
        coord_x = "longitude", coord_y = "latitude",
        present = FALSE,
        weight = (1 / n) * nrow(x) # weight presences and background equally
      )
    }, region = w_asia_land, n = n_background),
    # occ_bg = map2(occ, bg, bind_rows)
    occ = map2(occ, bg, bind_rows)
  ) |>
  select(-bg)
```

Random Forest is a presence–absence approach to niche modelling and therefore requires not just data on where a species is present, but where it is definitely not present.
However 'absence' data is rarely available because it requires exhaustive survey.
In practice, most applications of niche modelling are 'presence-only' and, where absence data is required (as for Random Forest), it is supplied as a random background sample of 'pseudo-absence' points.
The purpose of this sample is to inform the model about the nature of the underlying environment. 
The stochastic generation process means that some 'pseudo-absence' points will overlap or fall close to presences, so ensuring the model is not overly influenced by background samples is critical to its predictive importance [@ValaviEtAl2022].
Here we follow the advice of @BarbetMassinEtAl2012 for regression-based species distribution models and use a large (≈10000) uniform sample of points from across the land area of the study region.
These points are then weighted equally against the presences in the regression to produce a 'balanced Random Forest' [@ValaviEtAl2022].

## Predictor data {#sec-predictors}

We modelled the occurrence of species as a function of 24 geospatial predictor variables.
These included:

```{r data-climate}
# Reacquire derived_data/paleoclim if needed:
if (length(dir_ls(derived_data("paleoclim"), glob = "*.tif")) < 1) {
  message("Redownloading Paleoclim data...")
  source(here("data", "data-paleoclim.R"))
}

climate <- read_stars(
  derived_data(
    "paleoclim", 
    paste0("paleoclim_", climate_periods$code, "_2_5m_w_asia.tif")
  ),
  along = NA
)

names(climate) <- climate_periods$code

climate <- st_redimension(climate, name = "period") |>
  split("band")
```

* Sixteen 'bioclimatic' variables derived from monthly temperature and precipitation values, following standard practice for species distribution models [@HijmansEtAl2005]. Contemporary bioclimatic predictor data for West Asia was extracted from the global CHELSA dataset [@KargerEtAl2017], which predicts temperature and precipitation from downscaled general circulation model output at 1 km resolution.

```{r data-terrain}
# Reacquire derived_data/srtm_15plus_w_asia.tif if needed:
if (!file_exists(derived_data("dem", "srtm_15plus_w_asia.tif"))) {
  message("Redownloading DEM data...")
  source(here("data", "data-dem.R"))
}

terrain <- read_stars(derived_data("dem", c("srtm_15plus_w_asia.tif", 
                                            "srtm_15plus_w_asia_slope.tif",
                                            "srtm_15plus_w_asia_aspect.tif",
                                            "srtm_15plus_w_asia_wetness.tif")))
names(terrain) <- c("elevation", "slope", "aspect", "wetness")
```

* Terrain aspect and slope, which at high resolution perform well as proxies for solar radiation when modelling plant occurrence [@AustinVanNiel2011; @LeempoelEtAl2015]; and the topographic wetness index (TWI), which serves as a proxy for soil moisture and is particularly important in modelling arid environments [@KopeckyCizkova2010; @CamposEtAl2016; @DiVirgilioEtAl2018]. All three were derived from the SRTM15+ digital elevation model using algorithms from WhiteboxTools [@Lindsay2016].

```{r data-soil}
# Reacquire derived_data/soilgrids if needed:
if (length(dir_ls(derived_data("soilgrids"), glob = "*.tif")) < 1) {
  message("Redownloading SoilGrids data...")
  source(here("data", "data-soilgrids.R"))
}

soil <- map(dir_ls(derived_data("soilgrids")), read_stars)
names(soil) <- str_split_i(basename(names(soil)), "_", 2)
soil <- do.call(c, soil)
```

* Edaphic data from SoilGrids [@HenglEtAl2014; @HenglEtAl2017], which improves model performance for plants [@DubuisEtAl2013; @ModEtAl2016; @VelazcoEtAl2017]. Based on a recent assessment of the reliability of SoilGrids data for species distribution modelling [@MillerEtAl2024], we used a subset of four variables relating to soil texture (clay, silt, sand) and pH at the surface (0-5 cm depth).

```{r data-environment}
# Prepare environmental data cube for prediction (not training)
# Duplicate time-invariant predictors to create dummy period dimension
terrain_cube <- list(terrain) |>
  rep(nrow(climate_periods)) |>
  set_names(climate_periods$code) |>
  c(list(along = "period")) |>
  do.call(what = c)

soil_cube <- list(soil) |>
  rep(nrow(climate_periods)) |>
  set_names(climate_periods$code) |>
  c(list(along = "period")) |>
  do.call(what = c)

# Resample predictor data to common projection and resolution
climate_cube <- st_warp(climate, crs = w_asia_albers, 
                        cellsize = c(pred_res, pred_res), segments = 1000)
terrain_cube <- st_warp(terrain_cube, climate_cube, segments = 1000)
soil_cube <- st_warp(soil_cube, climate_cube, segments = 1000)

# Combine into prediction cube
environment <- c(climate_cube, terrain_cube, soil_cube)

# Save some memory
rm(climate_cube, terrain_cube, soil_cube)
```

For hindcasting, we used reconstructed bioclimatic data for three key climatologies generated from downscaled paleoclimate simulations from the HadCM3 general circulation model [@FordhamEtAl2017; @BrownEtAl2018]:
the Bølling–Allerød (c. 14.7–12.9 ka), the Younger Dryas (c. 12.9–11.7 ka), and the Early Holocene (11.7–8.3 ka).
Terrain and soil predictors were held constant, since reconstructions of these variables in the past are not available at sufficient scale.
It is unlikely that either macroscale topography or soil characteristics have altered significantly over the period of time considered here, so we assume that this does not degrade model performance, and may in fact benefit it by providing 'anchoring' predictors that are independent of climate change.

For training, test predictions, and archaeological predictions predictor data was left in its native projection and resolution.
For hindcast palaeodistributions, it was transformed to common equal-area projection and resolution of `r pred_res / 1000` km.

```{r data-flora-predictors}
# TODO: factor out
bind_extract <- function(x, y) {
  extract <- st_extract(y, st_transform(x, st_crs(y)))
  cbind(x, select(tibble(extract), -geometry))
}

flora <- flora |> 
  mutate(
    occ = map(occ, st_as_sf, coords = c("longitude", "latitude"), crs = latlong, remove = FALSE),
    occ = map(occ, bind_extract, slice(climate, "period", "cur")),
    occ = map(occ, bind_extract, terrain),
    occ = map(occ, bind_extract, soil)
  )
```

## Random Forest

```{r niche-data}
# Split training, test (for model assessment) and cross-validation sets (for
# tuning)
flora <- flora |>
  mutate(
    # De-sf
    occ = map(occ, \(x) select(tibble(x), -geometry)),
    # TODO: can this happen earlier?
    occ = map(occ, \(x) mutate(x, present = factor(present, c(FALSE, TRUE)))),
    occ = map(occ, \(x) mutate(x, weight = importance_weights(weight))),
    occ_split = map(occ, \(x) initial_split(x, strata = present)),
  )

# Data preprocessing recipe
# Following recommended preprocessing steps for RF classification from:
#   https://www.tmwr.org/pre-proc-table.html
niche_recipe <- recipe(training(flora$occ_split[[1]])) |>
  update_role(gbif_key:latitude, new_role = "ID") |>
  update_role(present, new_role = "outcome") |>
  update_role(starts_with("bio"), new_role = "predictor") |>
  update_role(c(elevation, slope, aspect, wetness, clay, phh2o, sand, silt),
              new_role = "predictor") |>
  # Impute missing values based on spatial autocorrelation
  step_impute_linear(all_numeric_predictors(), 
                     impute_with = imp_vars(latitude, longitude)) |>
  # Drop redundant predictors
  step_nzv(all_predictors())
```

Ecological niche modelling is a classification problem that can be approached with a wide range of statistical methods.
A substantial literature exists on the relatively performance of these approaches and their respective parameterisations [reviewed in @ValaviEtAl2022].
Random Forest, a widely-used machine learning algorithm, is amongst the best performing methods for presence-only species distribution models, providing it is appropriately parameterised to account for the class imbalance between presence and background samples [@ValaviEtAl2021; @ValaviEtAl2022].
For our application, it also has the advantage of requiring little to no manual parameter tuning to achieve good predictive results, which makes it easier to model a larger numbers of taxa.

```{r niche-model}
# Random Forest Niche Model
# With hyperparameters adapted from the example of a down-sampled RF model given 
# by https://rvalavi.github.io/SDMwithRFs/#model-fitting-with-ranger-package
niche_model <- rand_forest(mode = "classification", trees = 1000) |>
  set_engine(
    "ranger", 
    sample.fraction = c(sum(as.logical(.y())) / n_background, 1),
    importance = "impurity"
  )

niche_workflow <- workflow(niche_recipe, niche_model)
```

For each taxon we trained a classification model to predict occurrence (presence or absence/background) based on our 24 predictor variables (@sec-predictors).
We used the Random Forest algorithm implemented in the R package 'ranger' [@WrightZiegler2017] and the 'tidymodels' [@tidymodels] framework for data preprocessing and model selection.
To avoid overfitting, we follow @ValaviEtAl2021 in their recommended hyperparameters and use of down-sampling to balance presence and background samples.
Models for each taxon were fit independently, with redundant zero-variance predictors excluded, and assessed based on balanced training (¾) and test (¼) partitions.

```{r niche-fit}
# Fit best model to training data
if (!file_exists(derived_data("flora_niche_fit.Rdata"))) {
  flora <- mutate(
    flora,
    niche = map(occ_split, \(x) last_fit(niche_workflow, x), .progress = TRUE)
  )
  saveRDS(flora, derived_data("flora_niche_fit.Rdata"))
}
flora <- readRDS(derived_data("flora_niche_fit.Rdata"))
```

<!-- TODO: prediction, hindcasting and hindcasting assessment methodology -->

```{r niche-predict}
# NOTE: high memory usage
if (!file_exists(derived_data("flora_niche_predictions.Rdata"))) {
  flora <- flora |>
    mutate(
      pred = map(niche, collect_predictions),
      palaeodist = map(niche, \(mod, obj) predict(obj, extract_fit_engine(mod)),
                       obj = environment, .progress = TRUE),
      # Binarize
      palaeodist = map(palaeodist, mutate, present = prediction.TRUE. > 0.5),
      palaeodist = map(palaeodist, mutate, absent = prediction.FALSE. > 0.5)
    )
  saveRDS(flora, derived_data("flora_niche_predictions.Rdata"))
}
flora <- readRDS(derived_data("flora_niche_predictions.Rdata"))

# TODO write TIFs
```

# Model assessment

We trained Random Forest models for `r nrow(flora)` taxa using contemporary occurrence data from GBIF, a random sample of background points, and the predictor variables described in @sec-predictors.
Substituting the "current" climate predictors for those derived from palaeoclimatic simulations [@BrownEtAl2018], we could then generate hindcast predictions for reconstructed past environments in `r english(nrow(climate_periods))` key climate periods – a total of `r nrow(flora) * nrow(climate_periods)` modelled palaeodistributions.
Predicted distributions for individual taxa are presented in the appendix and accompanying material.

```{r data-model-assessment}
flora <- mutate(
  flora,
  niche_test_metrics = map(niche, collect_metrics),
  sensitivity = map(pred, sens, truth = present, estimate = .pred_class,
                    event_level = "second"), # reference present=TRUE
  niche_test_metrics = map2(niche_test_metrics, sensitivity, bind_rows)
) |>
  select(-sensitivity)

niche_test_summary <- flora |>
  unnest(niche_test_metrics) |>
  summarise(
    min = min(.estimate),
    max = max(.estimate),
    mean = mean(.estimate),
    sd = sd(.estimate),
    .by = c(.metric)
  )
```

```{r fig-model-sensitivity-vs-n_occ, warning=FALSE}
#| fig-cap: Model sensitivity by number of training occurrences
flora |>
  unnest(niche_test_metrics) |>
  filter(.metric == "sens") |>
  mutate(label = if_else(.estimate < 0.85, taxon, NA_character_)) |>
  ggplot(aes(n_occ, .estimate)) + 
  geom_smooth(method = "glm", formula = y ~ log(x)) +
  geom_point() + 
  geom_text_repel(aes(label = label), fontface = "italic", size = 10/.pt) +
  scale_x_log10(name = "Occurrences") +
  scale_y_continuous(name = "Sensitivity", labels = label_percent()) +
  theme_minimal_grid() 
```

We assessed the predictive performance of the fitted niche models in the contemporary environment based on the reserved test partition [@tbl-results-summary].
Model accuracy (proportion of correctly classified presence and background samples) ranged between `r percent(filter(niche_test_summary, .metric == "accuracy")$min)` and `r percent(filter(niche_test_summary, .metric == "accuracy")$max)`, with an average of `r percent(filter(niche_test_summary, .metric == "accuracy")$mean)`.
Sensitivity (proportion of correctly classified presence samples) ranged between `r percent(filter(niche_test_summary, .metric == "sens")$min)` and `r percent(filter(niche_test_summary, .metric == "sens")$max)`, with an average of `r percent(filter(niche_test_summary, .metric == "sens")$mean)`.
The area under the models' receiver operating characteristic curves (ROC-AUC) was on average `r round(filter(niche_test_summary, .metric == "roc_auc")$mean, 3)`±`r round(filter(niche_test_summary, .metric == "accuracy")$sd, 3)`
Model sensitivity is loosely correlated with the number of occurrences available for training (@fig-model-sensitivity-vs-n_occ), with the worst-performing models all having less than 300 recorded occurrences: `r knitr::combine_words(paste0("*", filter(unnest(flora, niche_test_metrics), .metric == "sens" & .estimate < 0.85)$taxon, "*"))`.
Test metrics and ROC curves for the individual models are included in the appendix.

```{r niche-predict-archaeo}
# Extract predictors and make predictions for archaeobotanical occurrences
# TODO: what about negatives?
if (!file.exists(derived_data("archaeo_pred.Rdata"))) {
  archaeo_pred <- flora |>
    unnest(archaeo) |>
    nest(.by = c(climate_period), .key = "archaeo") |>
    mutate(
      archaeo = map(archaeo, st_as_sf, coords = c("longitude", "latitude"),
                    crs = latlong, remove = FALSE),
      archaeo = map2(archaeo, climate_period, function(x, period) {
        bind_extract(x, slice(climate, "period", as.character(period)))
      }),
      archaeo = map(archaeo, bind_extract, terrain),
      archaeo = map(archaeo, bind_extract, soil)
    ) |>
    unnest(archaeo) |>
    nest(.by = any_of(colnames(flora)), .key = "archaeo") |> # Restore original nesting
    mutate(
      archaeo_pred = map2(niche, archaeo, function(x, y) {
        # TODO: shouldn't be necessary - remove from workflow
        y <- mutate(y, gbif_key = NA, scientific_name = NA, species = NA)
        augment(extract_workflow(x), new_data = y)
      })
    ) |>
    select(taxon, archaeo_pred)
  
  saveRDS(archaeo_pred, derived_data("archaeo_pred.Rdata"))
}
archaeo_pred <- readRDS(derived_data("archaeo_pred.Rdata"))

n_archaeo_pred_correct <- sum(as.logical(unnest(archaeo_pred, archaeo_pred)$.pred_class))
p_archaeo_pred_correct <- n_archaeo_pred_correct / nrow(unnest(archaeo_pred, archaeo_pred))
 
archaeo_pred_summary <- archaeo_pred |>
  unnest(archaeo_pred) |>
  summarise(
    n_predicted = sum(as.logical(.pred_class)),
    p_predicted = n_predicted / n(),
    .by = c(taxon)
  )

flora <- left_join(flora, archaeo_pred, join_by(taxon))
```

The ability of the hindcast models to predict the occurrence of specific species at archaeological sites is worse, with `r percent(p_archaeo_pred_correct)` of presences in archaeobotanical assemblages successfully predicted.
Model sensitivity (proportion of corrected predicted presenses) in relation to the archaeological data is on average `r round(mean(archaeo_pred_summary$p_predicted, na.rm=TRUE), 2)`±`r round(sd(archaeo_pred_summary$p_predicted, na.rm=TRUE), 2)` [@tbl-results-summary].
A full assessment of the hindcasting performance of the individual models can be found in the appendix.
<!-- TODO: negative -->

```{r niche-pred-range}
area_present <- function(pred, res = pred_res) {
  st_apply(pred, "period", sum, na.rm = TRUE)["present"] |>
    data.frame() |>
    mutate(area_present = present * (pred_res)^2) |>
    select(period, area_present)
}

flora <- mutate(flora, area_present = map(palaeodist, area_present))
```

```{r tbl-results-summary}
#| tbl-cap: "Summary of species modelled"
add_taxon_alias_footnotes <- function(tab, taxon_aliases) {
  rows <- which(map_lgl(taxon_aliases, \(x) length(x) > 0))
  notes <- map_chr(taxon_aliases[rows], function(aliases) {
    paste(
      "Including",
      knitr::combine_words(paste0("*", aliases, "*"))
    )
  })
  for (i in 1:length(rows)) {
    tab <- tab_footnote(tab, md(notes[i]), cells_body(c(taxon), rows = rows[i]))
  }
  tab
}

# TODO:
# - alt. taxons as footnotes
# - check boxes of which (climate?) periods observed in ?
results_summary <- flora_all |>
  left_join(flora, join_by(taxon, taxon_aliases, archaeo, n_archaeo)) |>
  left_join(archaeo_pred_summary, join_by(taxon)) |>
  mutate(n_occ = coalesce(n_occ.y, n_occ.x), .before = n_occ.x) |>
  # Extract model metrics
  unnest(c(niche_test_metrics), keep_empty = TRUE) |>
  select(-.estimator, -.config) |>
  pivot_wider(names_from = .metric, values_from = .estimate) |>
  # Excluded samples
  mutate(exclude = (n_occ < min_n_occ) | (taxon == "Avena sterilis")) |>
  # Prepare table
  select(taxon, taxon_aliases, n_archaeo, n_occ, exclude, accuracy, roc_auc, 
         sens, p_predicted) |>
  arrange(taxon)

results_summary |>
  select(-taxon_aliases) |>
  gt() |>
  cols_label_with(fn = str_to_sentence) |>
  cols_label(
    n_archaeo = "Arch.",
    n_occ = "Cur.",
    accuracy = "Acc.",
    roc_auc = "ROC-AUC",
    sens = "Sens.",
    p_predicted = "Sens. (arch.)"
  ) |>
  tab_spanner("Occurrences", columns = c(n_archaeo, n_occ)) |>
  tab_spanner("Model", columns = accuracy:p_predicted) |>
  cols_hide(exclude) |>
  tab_footnote(
    "Excluded from modelling due to sample size", 
    cells_body(columns = c(n_occ), rows = exclude),
    placement = "right"
  ) |>
  add_taxon_alias_footnotes(results_summary$taxon_aliases) |>
  cols_align("right") |>
  cols_align("left", c(taxon)) |>
  fmt_number(accuracy:p_predicted) |>
  sub_missing() |>
  tab_style(cell_text(style = "italic"), cells_body(taxon)) |>
  tab_options(
    # footnotes.marks = "*",
    table.font.size = 11,
    table.width = pct(100),
    latex.use_longtable = TRUE
  )
```

# Discussion

## Reduction in range sizes over the Pleistocene/Holocene boundary

```{r data-pred-range-summary}
flora_pred_area_present_summary <- flora |>
  unnest(area_present) |>
  summarise(med_area_present = median(area_present) / 1e6, .by = period) |>
  mutate(
    period_label = map(period, \(x) filter(climate_periods, code == x)$label),
    period_label = unlist(period_label),
  )

n_reduced_range <- flora |>
  unnest(area_present) |>
  pivot_wider(names_from = period, values_from = area_present) |>
  filter(eh < ba) |>
  nrow()

n_reduced_range_10 <- flora |>
  unnest(area_present) |>
  pivot_wider(names_from = period, values_from = area_present) |>
  filter(eh <= ba * 0.9) |>
  nrow()
```
  
```{r fig-pred-range-density, warning=FALSE}
#| fig-cap: Distribution of predicted species ranges by period. Dashed lines indicate the median range.
flora |>
  unnest(area_present) |> 
  mutate(
    period_label = map(period, \(x) filter(climate_periods, code == x)$label),
    period_label = unlist(period_label),
    area_present = area_present / 1e6 # m2 to km2
  ) |> 
  ggplot() + 
  facet_wrap(vars(period_label), ncol = 1, strip.position = "left") + 
  geom_density(aes(area_present)) +
  geom_vline(aes(xintercept = med_area_present), flora_pred_area_present_summary) +
  scale_x_log10(name = "Predicted range km²", labels = label_number_auto()) + 
  scale_y_continuous(name = NULL, labels = NULL) +
  theme_minimal_vgrid() +
  theme(
    strip.text.y.left = element_text(angle = 0, hjust = 0),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank()
  )
```

Our reconstructed palaeodistributions (shown in full in the appendix) indicate that the majority of species have experienced a significant reduction and/or shift in their ranges since the Early Holocene. 
`r n_reduced_range` of `r nrow(flora)` species have reduced ranges; `r n_reduced_range_10` of more than 10% or more.
Though the magnitude of the reduction from prehistory to the present likely reflects a degree of overfitting in the model (discussed further in @sec-discuss-hindcasting), fluctuations in modelled range size between the Bølling-Allerød (14.7–12.9 ka), Younger Dryas (12.9–11.7 ka), and Early Holocene (11.7–8.3 ka) are more directly comparable (@fig-pred-range-density).
The average range of modelled species was `r percent(1 - (filter(flora_pred_area_present_summary, period == "eh")$med_area_present / filter(flora_pred_area_present_summary, period == "ba")$med_area_present))` in the Early Holocene compared to the Bølling–Allerød, and `r percent(1 - (filter(flora_pred_area_present_summary, period == "yds")$med_area_present / filter(flora_pred_area_present_summary, period == "ba")$med_area_present))` during the Younger Dryas (i.e. ranges recovered slightly between the Younger Dryas and Early Holocene).
This perhaps indicates that although this period is considered one of climatatic amelioration globally [@JonesEtAl2019], the colder conditions of the Pleistocene may have supported more extensive plant-based economies in West Asia specifically.

```{r data-palaeodist-sum}
palaeodist_sum <- do.call(c, c(flora$palaeodist, list(along = "taxon"))) |>
  st_apply(c("x", "y", "period"), sum, na.rm = FALSE)
```

```{r fig-palaeodist-sum}
#| fig-cap: Predicted species richness (sum of predicted ranges) by period
# TODO: expand period facet labels
ggplot() +
  facet_wrap(vars(factor(period, levels = climate_periods$code, labels = climate_periods$label))) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_sum, present), 
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(crs = w_asia_albers) +
  labs(fill = "Richness", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "italic")
  )
```

Many taxa that occur (or are predicted to occur) across the 'hilly flanks' today—including most crop progenitors—are reconstructed to have had a significantly more restricted distribution in the terminal Pleistocene/Early Holocene (@fig-palaeodist-sum).
These include *Ficus carica* (fig);
*Hordeum* spp. (wild barleys);
*Lathyrus aphaca* and *L. sativus* (both marginally edible legumes);
*Triticum aestivum compactum* (in the N. Levant), *T. monococcum aegilopoides*, *T. durum*, and *Triticum urartu* (but not the other wheat progenitor, *T. turgidum dicoccum* – see @sec-discuss-crops);
*Aegilops speltoides*, but not *Aegilops tauschii* (goatgrasses);
and *Vicia* spp. (vetches), including *Vicia faba* (broad beans).
most of Anatolia, Northern Mesopotamia, and the Zagros Mountains in particular disappear from the predicted ranges of these species,
leaving the Levant and to a lesser extent the Aegean and Cyprus as refugia.

<!-- TODO expand/rewrite -->
Our results for the Levant are consistent with the current understanding of this region as developing early intensive foraging economies [the Natufian culture, @BarYosef1998] and as a centre of origin of agriculture [@Zeder2011a].
Within the Levant, many species show moderate reductions in ranges over the Pleistocene/Holocence boundary, retreating from the Badia/transjordan region (e.g. barley, fig. @fig-palaeodist-barely-levant).

Loss of the Northern Mesopotamia–Anatolia region from the predicted ranges of crop progenitors is interesting in light of the 'golden triangle' hypothesis [@Lev-YadunEtAl2000; @KozlowskiAurenche2005; @AbboEtAl2010], which puts this region at the centre of the development of agriculture.
Multiple lines of archaeological evidence have emerged that point away from this hypothesis and towards a more geographically diverse origin [@Asouti2006; @FullerEtAl2011; @ArranzOtaeguiEtAl2016], but it remains the area with some of the earliest clear evidence of domestication [@ZoharyEtAl2012; @KabukcuEtAl2021; @UlasEtAl2024].
Comparative genetics also points to the Northern Mesopotamia region as the centre of diversity of many crops [e.g. @HaasEtAl2019].
But since these studies are based on modern genomes, if the wild range of these plants has, as our modelling suggests, shifted since the Early Holocene, the apparent centre of diversity may have shifted with them.
Our reconstructions are consistent with the late arrival of intensive plant-based foraging economies in this region (cf. the Natufian of the Levant),
and more broadly there need not be a link between the core *wild* range of a plant and the core area of its domestication. 
A scenario in which cultivation emerged at the edges of the ranges of valuable plant resources—as a means of extend their natural niche—is also plausible.

The near-absence of the Zagros in any predicted ranges is also surprising, given mounting evidence that domestication took place just as early in the eastern *Mashriq* as it did in the west [@Zeder2024].
We consider that the most likely explanation for this is that our flora does not include the species that were most important to plant subsistence in the east.
Archaeobotanical data on Neolithic sites in the Zagros is limited (compared to the Levant in particular) due to a hiatus in field research there from the 1980s to early 2010s [@Zeder2024].
Recent research [@WhitlamEtAl2018; @GonzalezCarreteroEtAl2023] indicates that plant subsistence in this region was based on a distinct set of species, compared to the Levant and Anatolia.

Cyprus and the Aegean are not conventionally considered part of the primary zone of domestication but rather amongst the first regions that acquired agriculture from West Asia.
Our analysis complicates this picture, as it indicates that the wild ranges of many crop progenitors included these regions.
Early examples of several domesticates are recorded at sites on Cyprus, Western Anatolia and Greece [@ArranzOtaeguiRoe2023],
and the Aegean region was probably connected to West Asia by a land bridge via Anatolia until the Early Holocene [@AksuHiscott2022].
Were these area part of the same broader 'interaction sphere' that produce Neolithic agriculture in West Asia?

Exceptions to the dominant trend of range reduction include *Cicer reticulatum* (wild chickpea), which has a relatively stable range centered on Northern Mesopotamia;
and *Triticum turgidum dicoccum* (wild emmer wheat), which is predicted to have two limited ranges centered around the Black Sea Coast of Anatolia and the Palmyra basin.
In the latter case, neither of these areas are part of the predicted modern distribution of wild emmer (centered around the Caucasus and Northern Mesopotamia), but it would be consistent with archaeological evidence for early cultivation at sites in the Upper Euphrates [@Willcox2024].

## Biogeography of crop progenitors {#sec-discuss-crops}

```{r fig-palaeodist-chickpea-rye}
#| fig-cap: Predicted palaeodistribution of wild chickpea and rye in the Early Holocene (11.7–8.2 ka)
chickpea_rye <- c("Secale cereale", "Cicer reticulatum")
palaeodist_chickpea_rye <- do.call(c, c(
  filter(flora, taxon %in% chickpea_rye)$palaeodist,
  list(along = list(taxon = filter(flora, taxon %in% chickpea_rye)$taxon))
))

ggplot() +
  facet_wrap(vars(taxon)) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_chickpea_rye, prediction.TRUE.) |>
               filter(period == "eh"), 
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(crs = w_asia_albers) +
  labs(fill = "P(present)", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(face = "italic")
  )
```

Almost all the cereal and legume crop progenitors we modelled are predicted to have only been found in the Levant during the terminal Pleistocene and Early Holocene (see appendix).
Part of this may be do with the fact that both our initial flora and training occurrence dataset have a strong bias towards the southern Levant, but strikingly the modelled *current* ranges of these plants do tend to include Anatolia and the Zagros, so this cannot be the only factor.
One notable exception is the wild ancestor of chickpea (*Cicer reticulatum*), which is predicted to have a distribution centered on Northern Mesopotamia but encompassing much of the the 'hilly flanks' (except the southern Levant, @fig-palaeodist-chickpea-rye). 
Another is rye (*Secale cereale*), which is inferred to be primarily Western Anatolian (@fig-palaeodist-chickpea-rye).
This is perhaps relevant to rye's unusual domestication history, as a crop of West Asian origin that was apparently not first cultivated until much later than the 'founder crops', in Europe [@SchreiberEtAl2021].

```{r fig-palaeodist-locals}
#| fig-cap: Predicted palaeodistribution of flax, pistachio and clubrush in the Early Holocene (11.7–8.2 ka)
locals <- c("Linum bienne", "Pistacia atlantica", "Bolboschoenus maritimus")
palaeodist_locals <- do.call(c, c(
  filter(flora, taxon %in% locals)$palaeodist,
  list(along = list(taxon = filter(flora, taxon %in% locals)$taxon))
))

ggplot() +
  facet_wrap(vars(taxon), nrow = 2) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_locals, prediction.TRUE.) |>
               filter(period == "eh"), 
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(crs = w_asia_albers) +
  labs(fill = "P(present)", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(face = "italic")
  )
```

Flax (*Linum bienne*) is predicted to have had a highly concentrated distribution in Cyprus and along the Mediterranean coast of the southern Levant.
This is consistent with its low ubiquity in archaeobotanical assemblages [@ArranzOtaeguiRoe2023], despite conventionally being considered a 'founder crop', and presumably implies that its domestication was similarly geographically constrained.
It is the only unambiguous crop progenitor with such a restricted range, though pistachio (*Pistacia atlantica*) and clubrush (*Bolboschoenus maritimus*) are similarly constrained to the Mediterranean coast (and North Africa, in the case of pistachio).

```{r fig.height=10, fig-palaeodist-barely-levant, cache=TRUE}
#| fig-cap: Predicted palaeodistribution of wild barleys in the Levant
# TODO: why so slow?
palaeodist_hordeum <- do.call(c, c(
  filter(flora, str_starts(taxon, "Hordeum"))$palaeodist,
  list(along = list(taxon = filter(flora, str_starts(taxon, "Hordeum"))$taxon))
))

ggplot() +
  facet_grid(taxon ~ fct_relabel(period, toupper)) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_hordeum, prediction.TRUE.), 
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  scale_x_continuous(breaks = c(34, 36, 38)) +
  scale_fill_batlow(reverse = TRUE) +
  coord_sf(
    xlim = c(33, 39), ylim = c(30, 38),
    crs = w_asia_albers, default_crs = latlong
  ) +
  labs(fill = "P(present)", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "italic")
  )
```

Wild barley (*Hordeum spontaneum*) its relatives show a contraction of their predicted ranges from the Pleistocene to the Holocene,
concurrent with it being brought into cultivation (@fig-palaeodist-barely-levant).
It also sees a marked decline in the archaeobotanical record from the Early PPNA/Early PPNB (where it was amongst the most common taxa) to the Late PPNB and Late Neolithic [@ArranzOtaeguiRoe2023].
Pistachio (*Pistacia atlantica*) shows similar trends, but it is less certain that this species was cultivated in the Neolithic.
Conversely, the various wild wheat species native to West Asia show almost no response to Pleistocene/Holocene climate change, even within the Levant, and in the archaeobotanical record wheat displays the opposite trend to barley and pistachio – becoming gradually more abundant through the course of the Neolithic and dominant by its end.
We hypothesise that climate-linked range shifts were a factor driving these changes in the apparent economic important of different crops:
the decreasing availability of barley and pistachio in the terminal Pleistocene may have prompted cultivation as a strategy to retain access to them,
though in the long run it made them less attractive as staple crops compared to the more resilient wheat.
However, these dynamics are not seen in the majority of crop progenitors.

```{r fig-palaeodist-bread}
#| fig-cap: Combined predicted palaeodistributions of bread wheat progenitors
bread <- c("Aegilops tauschii", "Aegilops speltoides", 
           "Triticum turgidum dicoccum", "Triticum urartu")
palaeodist_bread <- do.call(c, c(
  filter(flora, taxon %in% bread)$palaeodist,
  list(along = list(taxon = filter(flora, taxon %in% bread)$taxon))
)) |>
  st_apply(c("x", "y", "period"), sum, na.rm = FALSE) |>
  mutate(present = factor(present))

ggplot() +
  facet_wrap(vars(fct_relabel(period, toupper))) +
  annotation_spatial(ne_land, fill = "white") +
  geom_stars(data = select(palaeodist_bread, present), 
             na.action = na.omit) +
  annotation_spatial(ne_land, fill = NA) +
  annotation_spatial(w_asia, fill = NA) +
  scale_fill_batlow(reverse = TRUE, discrete = TRUE) +
  coord_sf(crs = w_asia_albers) +
  labs(fill = "N present", x = NULL, y = NULL) +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_text(face = "italic")
  )
```

Bread wheat (*Triticum aestivum*), the most common wheat cultivar today, has a complex ancestry that involves two recent hybridisation events [@LevyFeldman2022]:
most recently between emmer (*Triticum turgidum dicoccum*) and a goatgrass (*Aegilops tauschii*) c. 9 ka, and before that, in emmer, between wild red einkorn (*T. urartu*) and another goatgrass (*Aegilops speltoides*).
Although there is fairly wide overlap between these species today, according to our modelling the only place all four (or even just three) are predicted to have coincided or been found in close proximity to eachother in the time frame of domestication is a narrow area around the Orontes river in the northern Levant (@fig-palaeodist-bread).
This area is c. 200 km from the only two sites in our archaeobotanical database where either both species of wheat or both species of wheat and the goatgrasses are found together: Tell Abu Hureyra and El Kowm II [@ArranzOtaeguiRoe2023].^[We are grateful to Benjamin Nowak for pointing this out to us.]
Taken together this suggests an origin of domesticated bread wheat, otherwise only loosely geographically constrained to the Levant–Upper Euphrates corridor [@LevyFeldman2022], is likely to occur in this vicinity.

## Hindcast models do not predict archaeobotanical composition {#sec-discuss-hindcasting}

The failure of our hindcast models to predict the occurrence of species in archaeobotanical assemblages has several possible explanations. 
Since they do accurately predict the test dataset <!-- TODO: and past negatives? -->, a likely culprit is overfitting of the models to the present environment.
This implies that the modelled palaeodistributions should be seen as conservative estimates or a minimal range.
Another obvious flaw in our methodology is that the time slices used for palaeoclimatic reconstruction are very broad—each covering around two millennia—and therefore potentially unrepresentative of the environment around sites at the specific time at which they were occupied.
The variable quality of the archaeological test dataset, especially in terms of chronology, is also a plausible factor.

At the same time, we cannot rule out more substantive reasons for the discrepency between predicted and observed archaeological occurrences.
The niches of the modelled species could have changed since the Early Holocene, which would not be captured in a model trained purely on modern specimens.
Human economic choices—mobility, foraging strategies, cultivation, etc.—could also produce archaeobotanical assemblages whose composition depart significantly from that of the surrounding local flora.
Further refinement of the methodology for hindcast palaeoecological niche models, for example using more finely resolved palaeoclimate sequences [e.g. @KargerEtAl2023], hyperparameter tuning to avoid overfitting, and improved archaeological datasets, would help disentangle these potential explanations.

It is consistent with more "macro" trends such as the reduced range of Hordeum and Pistacia correlating with its reduced abundance in the archaeobotanical record.
<!-- TODO: do model predictions match more aggregated stats e.g. biodiversity? -->

# Conclusion

We present the first continuous, spatially explicit models of the palaeodistributions of `r nrow(flora)` plant species found regularly in association with Late Epipalaeolithic and Early Neolithic sites in West Asia.
This deductive approach—modelling the niche of a species based on its occurrence in relation to environmental factors today, and using this together with palaeoclimate simulations to infer its past distribution—represents a new line of evidence on the archaeoecology of the world's first agricultural societies.
It provides a complementary picture to that gleaned from environmental archaeology and climatological archives because it is independent of the taphonomic, anthropic, and recovery-related processes that affect these records.

"All models are wrong" [@Box1976], but the performance of our models on independent test datasets give confidence in its predictions, which are plausible and consistent with broad-scale patterns in the archaeological record.

* Results w.r.t. to specific archaeologically-attested species not to promising, but this doesn't mean the models are useless!
* Discrepancies suggests several areas for further research and methodological development

Modelling a large number of species using machine learning, the substantial occurrence datasets available for the present day, and a hindcasting approach to past distributions also represents a significant advance in the methodology of palaeoecological niche modelling. 
This approach is enabled by the availability of high quality, global open datasets in ecology [@GBIF2025; @GBIFSecretariat2023], earth science [@SRTM], and climatology [@KargerEtAl2017; @BrownEtAl2018].
Unfortunately in relation to these fields open data in archaeology lags conspiciously behind.
Though we have benefited from the relatively long tradition of compiling archaeobotanical data in our region of study [@ColledgeEtAl2004; @ShennanConolly2007; @ADEMNES; @LucasFuller2018; @FullerEtAl2018; @WallaceEtAl2018; @ORIGINS], 
further development of open, comprehensive and up-to-date 'backbone' datasets on site locations and chronologies is needed to advance archaeoecological modelling to the same level.

# Data availability

The data and R code used to produced is archived with Zenodo at <https://doi.org/10.5281/zenodo.14629984>

# References {.appendix}
